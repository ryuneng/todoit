<%@page import="utils.NumberUtils"%>
<%@page import="java.util.HashMap"%>
<%@page import="java.util.Map"%>
<%@page import="java.util.List"%>
<%@page import="dao.MeetingReplyDao"%>
<%@page import="vo.MeetingReply"%>
<%@page import="vo.User"%>
<%@page import="dao.WishDao"%>
<%@page import="vo.Wish"%>
<%@page import="utils.StringUtils"%>
<%@page import="utils.DateUtils"%>
<%@page import="dao.MeetingDao"%>
<%@page import="vo.Meeting"%>
<%@page import="dto.LoginUser"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<title>TODOIT::ëª¨ì„ìƒì„¸</title>
</head>
<body>
<jsp:include page="../include/navbar.jsp">
	<jsp:param value="meeting" name="menu"/>
</jsp:include>
<div class="container">
	<div class="row">
<%
	LoginUser loginUser = (LoginUser)session.getAttribute("LOGIN_USER");

	int meetNo = Integer.valueOf(request.getParameter("meetNo"));
	int currentPage = NumberUtils.toInt(request.getParameter("page"), 1);
	String error = request.getParameter("error");
	
	// ìˆ˜ì • í¼ì—ì„œ ì—ëŸ¬ denyë¡œ ì£¼ë©´ ì–¼ëŸ¿ ë³´ë‚´ê¸°
	if("deny".equals(error)) {
%>
		<div class="alert alert-danger">
			ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì£¼ìµœí•œ ëª¨ì„ì€ ìˆ˜ì •/ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
		</div>
<%
	}
	if("dangerFail".equals(error)) {
%>
<script type="text/javascript">
	alert('ì´ë¯¸ ì‹ ê³ í•œ ëŒ“ê¸€ì€ ì‹ ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤..');
</script>
<%
	}
	if("dangerSuccess".equals(error)) {
%>
<script type="text/javascript">
	alert('ëŒ“ê¸€ì´ ì‹ ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.');
</script>
<%
	}
	
	MeetingDao meetingDao = new MeetingDao();
	Meeting meeting = meetingDao.getMeetingByNo(meetNo);

	if (loginUser != null && loginUser.getNo() == meeting.getUser().getNo()) {
%>
		<div class="text-end mb-2">
			<a class="btn btn-warning " href="modifyForm.jsp?meetNo=<%=meetNo %>" >ìˆ˜ì •</a>
			<a class="btn btn-danger "  href="delete.jsp?meetNo=<%=meetNo %>">ì‚­ì œ</a>
		</div>
<%
	}
	meeting.setViewCnt(meeting.getViewCnt() + 1);
	meetingDao.updateMeetingByNo(meeting);
%>
		<h4 class="mt-3"><%=meeting.getTitle() %></h4>
		<div class="text-end" >ì¡°íšŒìˆ˜ : <%=meeting.getViewCnt() %></div>
	</div>
	<div class="row mb-3">
		<div class="col-12 mb-3">
			<table class="table table-bordered table " >
				<colgroup>
					<col width="30%">
					<col width="10%">
					<col width="20%">
					<col width="10%">
					<col width="20%">
				</colgroup>
				<tbody class="align-middle">
					<tr>
						<td rowspan="5"><img alt="meeting ëŒ€í‘œ ì´ë¯¸ì§€" src="/resources/images/meeting/<%=meeting.getImageName() %>"
									class="img-thumbnail"/></td>
					</tr>
					<tr>
						<th>ì¹´í…Œê³ ë¦¬</th>
						<td><%=meeting.getCategory().getName() %></td>
<%
	if (meeting.getActualPeople() == meeting.getMaxPeople()) {
%>
						<th>ì¸ì›ìˆ˜</th>
						<td ><span class="text-decoration-line-through">
							<%=meeting.getActualPeople() %> / <%=meeting.getMaxPeople() %> ëª…</span>
										<strong style="color:red;">ë§ˆê°</strong></td>
<%
	} else {
%>
						<th>ì¸ì›ìˆ˜</th>
						<td ><%=meeting.getActualPeople() %> / <%=meeting.getMaxPeople() %> ëª…</td>
<%
	}
%>
					</tr>
					<tr>
						<th>ì§€ì—­</th>
						<td><%=meeting.getAddress() %></td>
<%
	if (meeting.getPrice() != meeting.getDiscountPrice()) {
%>
						<th>ëª¨ì„ ê°€ê²©</th>
						<td><span class="text-decoration-line-through"><%=meeting.getPrice() %></span>
							<span style="color:red; bold"><%=meeting.getDiscountPrice() %></span> ì›</td>
<%
	} else if (meeting.getPrice() == meeting.getDiscountPrice()) {
%>
						<th>ëª¨ì„ ê°€ê²©</th>
						<td><%=meeting.getPrice() %>ì›</td>
<%
	}
%>
					</tr>
					<tr>
						<th>ì¼ì •</th>
						<td><%=DateUtils.toText(meeting.getStartDate()) %> ~ <%=DateUtils.toText(meeting.getEndDate()) %></td>
						<th>ëª¨ì„ í‰ì </th>
						<td><%=meeting.getScoreAverage() %></td>
					</tr>
					<tr>
						<th colspan="1">í˜¸ìŠ¤íŠ¸</th>
						<td colspan="3">
							<div class="d-flex justify-content-start">
								<div><img class="m-1" alt="í˜¸ìŠ¤íŠ¸ ì´ë¯¸ì§€" src="/resources/images/user/<%=meeting.getUser().getFilename() %>"
											style="width:50px"/></div>
								<div class="ms-3 mt-1">
									<div><%=meeting.getUser().getNickname() %> ë‹˜</div>
									<div><%=meeting.getUser().getContent() %></div>
								</div>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		<hr>
		</div>
	</div>
	<div class="row mb-3">
		<div class="col-12">
			<div class="bg-light p-3 mb-3 ">
				<%=StringUtils.withBr(meeting.getContent()) %>
			</div>
			<div id="map" style="width: 100%; height:400px;" data-lat="<%=meeting.getLatitude() %>" data-lon="<%=meeting.getLongitude() %>">
			
			</div>
			<div class="text-center mt-3">
<%
	if (loginUser == null) {
%>
				<button class="btn btn-success" type="button" onclick="loginAlert()">
					ì°œ <i class="bi bi-bookmarks"></i></button>
<%
	} else {
%>
				<a class="btn btn-success " href="insertWish.jsp?meetNo=<%=meetNo%>">ì°œ <i class="bi bi-bookmarks"></i></a>
<%
	}
%>
				<a class="btn btn-primary " href="/payments/form.jsp?meetNo=<%=meeting.getNo() %>">ì°¸ì—¬ ì‹ ì²­ <i class="bi bi-credit-card"></i></a>
				<a class="btn btn-warning" >ë¬¸ì˜ <i class="bi bi-question-circle"></i></a>
			</div>
			<div class="text-end" >
				<a class="btn btn-secondary"  href="list.jsp?page=<%=currentPage %>">ëª©ë¡</a>
			</div>
		</div>
	</div>

	<div class="row mb-3">
		<div class="col-12 mb-3">
		<hr>
			<h5>ëŒ“ê¸€</h5>
			<form class="border bg-light p-3 mb-3"
				method="post"
				action="insertReply.jsp">
				<input type="hidden" name="meetNo" value="<%=meeting.getNo() %>">
				<div class="row">
					<div class="col-sm-11">
						<textarea rows="2" class="form-control" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
					</div>
					<div class="col-sm-1 ">
						<button type="submit" class="btn btn-outline-primary">ë“±ë¡</button>
					</div>
				</div>
			</form>
		</div>
	</div>
			
	<div class="row">
		<div class="col-12">
<%
	MeetingReplyDao meetingReplyDao = new MeetingReplyDao();
	
	// ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
	List<MeetingReply> meetReplyList = meetingReplyDao.getMeetingReplies(meeting.getNo());
	
	// ëŒ“ê¸€ í•˜ë‚˜ì”© ë‚˜íƒ€ë‚´ëŠ” forë¬¸
	for(MeetingReply meetingReply : meetReplyList) {
		// ë²„íŠ¼ í‘œì‹œ ê¸°ë³¸ê°’ falseë¡œ ì„¤ì •í•˜ê¸¸
		boolean showDelBtn = false;
		boolean showModifyBtn = false;
		boolean showDangerBtn = false;
%>
			<div class="card mb-3">
				<div class="card-header">
					<span style="font-weight:bold"><%=meetingReply.getUser().getNickname() %></span>
					<small><%=DateUtils.toText(meetingReply.getUpdatedDate()) %></small>
<%
		if (loginUser == null) {
			// ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì¼ ê²½ìš° ë¡œê·¸ì¸ìš”ì²­ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
%>
					<button class="btn btn-outline-danger btn-sm float-end " type="button" onclick="loginAlert()">ğŸš¨</button>
<% 
		} else if (loginUser.getNo() == meetingReply.getUser().getNo()) {
			// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëŒ“ê¸€ ì‘ì„±ìì¸ ê²½ìš°
			showDelBtn = true;
			showModifyBtn = true;
		} else if(loginUser.getNo() == 100001 || loginUser.getNo() == meeting.getUser().getNo()) {
			// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¼ ê²½ìš°
			// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëª¨ì„ í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš°
			showDelBtn = true;
		} else if (loginUser.getNo() != meetingReply.getUser().getNo()) {
			// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì¼ë°˜ ì‚¬ìš©ìì¼ ê²½ìš°
			showDangerBtn = true;
		}
		
		if (showDelBtn) {
%>
					<a href="deleteReply.jsp?meetNo=<%=meeting.getNo() %>&replyNo=<%=meetingReply.getNo() %>"
						class="btn btn-danger btn-sm float-end ms-1"><i class="bi bi-trash"></i>
					</a>
<%
		}
		if (showModifyBtn) {
%>
					<button type="button" onclick="toggleReplyUpdateForm(<%=meetingReply.getNo() %>)"
						class="btn btn-warning btn-sm float-end "><i class="bi bi-eraser"></i>
					</button>
<%
		}
		if (showDangerBtn) {
%>
					<a href="insertReplyDangerCnt.jsp?meetNo=<%=meeting.getNo() %>&replyNo=<%=meetingReply.getNo() %>"
						class="btn btn-outline-danger btn-sm float-end">ğŸš¨
					</a>
<%
		}
%>
				</div>
				<div class="card-body">
<%		if(meetingReply.getDangerCount() >= 5) {%>
					<p class="card-text">ì‹ ê³ ëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</p>
<%		} else {%>
					<p class="card-text">
						<%=meetingReply.getContent() %>
					</p>
<%
		}
%>
					<form class="border bg-light p-3 mb-3 d-none"
						id="form-update-reply-<%=meetingReply.getNo() %>"
						method="post"
						action="modifyReply.jsp">
						<input type="hidden" name="meetNo" value="<%=meeting.getNo() %>">
						<input type="hidden" name="replyNo" value="<%=meetingReply.getNo() %>">
						<div class="row mb-3">

							<div class="col-sm-11">
								<textarea rows="2" class="form-control" name="content"><%=meetingReply.getContent() %></textarea>
							</div>
							<div class="col-sm-1 ">
								<button type="submit" class="btn btn-outline-primary" >ìˆ˜ì •</button>
							</div>
						</div>
					</form>
<%
		List<MeetingReply> meetReReplyList = meetingReplyDao.getReReplies(meetingReply.getNo());

		// ëŒ€ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
		for (MeetingReply meetingReReply : meetReReplyList) {
%>
					<!-- ëŒ€ëŒ“ê¸€ ì‘ì„±ì ë‚˜íƒ€ë‚´ëŠ” ë¶€ë¶„ -->
					<div class="card mb-3">
						<div class="card-header">
							<span style="font-weight:bold"><%=meetingReReply.getUser().getNickname() %></span>
							<small><%=DateUtils.toText(meetingReReply.getUpdatedDate()) %></small>
<%
			// ëŒ€ëŒ“ê¸€ ìˆ˜ì • ì‚­ì œ ì‹ ê³ ë²„íŠ¼ ê¸°ë³¸ê°’ falseë¡œ ì„¤ì •
			boolean showDelBtnRe = false;
			boolean showModifyBtnRe = false;
			boolean showDangerBtnRe = false;
			
			if (loginUser == null) {
%>
							<!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìì¼ ê²½ìš° ë¡œê·¸ì¸ìš”ì²­ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤. -->
							<button class="btn btn-outline-danger btn-sm float-end " type="button" onclick="loginAlert()">ğŸš¨</button>
<%				
			} else if (loginUser.getNo() == meetingReReply.getUser().getNo()) {
				// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëŒ€ëŒ“ê¸€ ì‘ì„±ìì¸ ê²½ìš°
				showDelBtnRe = true;
				showModifyBtnRe = true;
			} else if(loginUser.getNo() == 100001 || loginUser.getNo() == meeting.getUser().getNo()) {
				// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ê´€ë¦¬ìì¼ ê²½ìš°
				// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ëª¨ì„ í˜¸ìŠ¤íŠ¸ì¸ ê²½ìš°
				showDelBtnRe = true;
			} else if (loginUser.getNo() != meetingReReply.getUser().getNo()) {
				// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì¼ë°˜ ì‚¬ìš©ìì¼ ê²½ìš°
				showDangerBtnRe = true;
			}
			if (showDelBtnRe) {
%>
							<a href="deleteReply.jsp?meetNo=<%=meeting.getNo() %>&replyNo=<%=meetingReReply.getNo() %>"
								class="btn btn-danger btn-sm float-end ms-1"><i class="bi bi-trash"></i>
							</a>
<%
			}
			if (showModifyBtnRe) {
%>								
							<button type="button" onclick="toggleReplyUpdateForm(<%=meetingReReply.getNo() %>)"
								class="btn btn-warning btn-sm float-end "><i class="bi bi-eraser"></i>
							</button>
<%
			}
			if (showDangerBtnRe) {
%>
							<a href="insertReplyDangerCnt.jsp?meetNo=<%=meeting.getNo() %>&replyNo=<%=meetingReReply.getNo() %>"
								class="btn btn-outline-danger btn-sm float-end " 
								>ğŸš¨
							</a>
<%
}
%>
						</div>
						<!-- ëŒ€ëŒ“ê¸€ ë‚´ìš©ë¶€ë¶„ -->
						<div class="card-body">
<%			if(meetingReReply.getDangerCount() >= 5) {%>
							<p class="card-text">ì‹ ê³ ëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</p>
<%			} else {%>
							<p class="card-text">
							<%=meetingReReply.getContent() %>
							</p>
<%

			}
%>
							<!-- ëŒ€ëŒ“ê¸€ ìˆ˜ì •í¼ toggleë¡œ ëˆŒë €ì„ ë•Œ ë‚˜íƒ€ë‚˜ê²Œ í‘œí˜„ -->
							<form class="border bg-light p-3 mb-2 d-none"
								id="form-update-reply-<%=meetingReReply.getNo() %>"
								method="post"
								action="modifyReply.jsp">
								<input type="hidden" name="meetNo" value="<%=meeting.getNo() %>">
								<input type="hidden" name="replyNo" value="<%=meetingReReply.getNo() %>">
								<div class="row me-1">
									<div class="col-11">
										<textarea rows="2" class="form-control" name="content"><%=meetingReReply.getContent() %></textarea>
									</div>
									<div class="col-1 ">
										<button type="submit" class="btn btn-outline-primary" >ìˆ˜ì •</button>
									</div>
								</div>
							</form>
						</div>
					</div>
<%
		}
%>
					<!-- ëŒ€ëŒ“ê¸€ ì…ë ¥í¼ -->
					<form class="border bg-light p-3 mt-3"
						method="post"
						action="insertReReply.jsp">
						<input type="hidden" name="meetNo" value="<%=meeting.getNo() %>">
						<input type="hidden" name="partentsReply" value="<%=meetingReply.getNo() %>">
						<div class="row me-1">
							<div class="col-sm-11">
								<textarea rows="2" class="form-control" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
							</div>
							<div class="col-sm-1 ">
								<button type="submit" class="btn btn-outline-primary" >ë“±ë¡</button>
							</div>
						</div>
					</form>
				</div>
			</div>
<%
	}
%>
		</div>
	</div>
		<hr>
		<div class="row">
			<div class="col-12">
				<h5>ë‹¤ë¥¸ ëª¨ì„ ì¶”ì²œ</h5>
				<div class="row mb-3 justify-content-between">
<%
	List<Meeting> meetingList = meetingDao.getRecommendMeetings("like", 1, 4);
	for (Meeting recommendMeeting : meetingList) {
%>
				<div class="card col-3 m-1" style="width: 23%;" >
					<div class="card-header ">
						<a href="detail.jsp?meetNo=<%=meeting.getNo() %>&page=<%=currentPage %>" style="text-decoration-line:none;">
							<img src="/resources/images/meeting/<%=recommendMeeting.getImageName() %>" class="img-fluid" alt="ëª¨ì„ëŒ€í‘œ ì´ë¯¸ì§€">
						</a>
					</div>
					<div class="card-body">
						<a href="detail.jsp?meetNo=<%=meeting.getNo() %>&page=<%=currentPage %>" style="text-decoration-line:none;">
							<strong class="text-black"><%=recommendMeeting.getContent() %></strong>
						</a>
					</div>
				</div>
<%
	}
%>
				</div>
			</div>
		</div>
</div>


<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8969454c0c7cb8ee61ed937eb735f33c&libraries=services"></script>
<script>
	var container = document.getElementById('map'); //ì§€ë„ë¥¼ ë‹´ì„ ì˜ì—­ì˜ DOM ë ˆí¼ëŸ°ìŠ¤
	var lat = container.getAttribute("data-lat")
	var lon = container.getAttribute("data-lon")
	var options = { //ì§€ë„ë¥¼ ìƒì„±í•  ë•Œ í•„ìš”í•œ ê¸°ë³¸ ì˜µì…˜
		center: new kakao.maps.LatLng(lat, lon), //ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ.
		level: 3 //ì§€ë„ì˜ ë ˆë²¨(í™•ëŒ€, ì¶•ì†Œ ì •ë„)
	};
	
	var map = new kakao.maps.Map(container, options); //ì§€ë„ ìƒì„± ë° ê°ì²´ ë¦¬í„´
	
	function toggleReplyUpdateForm(replyNo) {
		document.getElementById("form-update-reply-" + replyNo).classList.toggle('d-none');
	}
	
	function loginAlert() {
		alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
	}
	
</script>
</body>
</html>