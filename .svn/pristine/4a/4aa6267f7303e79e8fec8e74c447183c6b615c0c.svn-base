<%@page import="dao.CommCategoryDao"%>
<%@page import="vo.CommCategory"%>
<%@page import="utils.DateUtils"%>
<%@page import="dto.Pagination"%>
<%@page import="vo.Community"%>
<%@page import="java.util.List"%>
<%@page import="dao.CommunityDao"%>
<%@page import="java.util.HashMap"%>
<%@page import="java.util.Map"%>
<%@page import="utils.NumberUtils"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<title>TODOIT :: ì»¤ë®¤ë‹ˆí‹°</title>
</head>
<body>
<jsp:include page="../include/navbar.jsp">
	<jsp:param value="community" name="menu"/>
</jsp:include>
<%
	// ìš”ì²­ íŒŒë¼ë¯¸í„°ê°’ ì¡°íšŒ
	int categoryNo = NumberUtils.toInt(request.getParameter("catNo"), 0);
	int currentPage = NumberUtils.toInt(request.getParameter("page"), 1);
	int rows = NumberUtils.toInt(request.getParameter("rows"), 10);
	String sort = request.getParameter("sort");
	String opt = request.getParameter("opt");
	String keyword = request.getParameter("keyword");
	
	// ê²€ìƒ‰ì— í•„ìš”í•œ ì •ë³´ë¥¼ ë‹´ëŠ” Map ê°ì²´ ìƒì„±
	Map<String, Object> param = new HashMap<>();
	
	if (categoryNo != 0) {						 // Mapì— ì¹´í…Œê³ ë¦¬ë²ˆí˜¸ ì €ì¥
		param.put("categoryNo", categoryNo);
	}
	param.put("rows", rows);			 		 // Mapì— ì¶œë ¥ê°œìˆ˜ ì €ì¥
	if (sort == null) {					 		 // ì •ë ¬ë°©ì‹ì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ì€ date
		sort = "date";
	}
	param.put("sort", sort);			 		 // Mapì— ì •ë ¬ë°©ì‹ ì €ì¥
	if (opt != null && !opt.isBlank()) { 		 // Mapì— ê²€ìƒ‰ì˜µì…˜ ì €ì¥
		param.put("opt", opt);
	}
	if (keyword != null && !keyword.isBlank()) { // Mapì— ê²€ìƒ‰ì–´ ì €ì¥
		param.put("keyword", keyword);
	}
	
	// communityDao ê°ì²´ ìƒì„±
	CommunityDao communityDao = new CommunityDao();
	
	// ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ
	int totalRows = communityDao.getTotalRows(param);
	
	// í˜ì´ì§•ì²˜ë¦¬ Pagination ê°ì²´ ìƒì„±
	Pagination pagination = new Pagination(currentPage, totalRows, rows);
	
	// ì „ì²´ í˜ì´ì§€ë²ˆí˜¸ì— í•´ë‹¹í•˜ëŠ” ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒí•˜ê¸°
	param.put("begin", pagination.getBegin());
	param.put("end", pagination.getEnd());
	
	List<Community> communityList = communityDao.getCommunities(param);
	
	// ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
	CommCategoryDao commCategoryDao = new CommCategoryDao();
	List<CommCategory> commCategoryList = commCategoryDao.getAllCategories();
%>
<div class="container" style="width: 1200px">
	<div class="row">
		<div class="col-12">
			<!-- ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ì˜ì—­ ì‹œì‘ -->
			<ul class="nav justify-content-evenly p-3 mb-5">
<%
	for (CommCategory commCategory : commCategoryList) {
%>
			    <li class="nav-item">
			        <a class="nav-link fs-1 <%=commCategory.getNo() == categoryNo ? "text-primary" : "text-black link-secondary" %>"
			           href="list.jsp?catNo=<%=commCategory.getNo()%>"
			           onclick="changeCategory(event, <%=commCategory.getNo() %>)">
			        	<i class="bi bi-<%=commCategory.getNo() == 100000 ? "people-fill" : "chat-square-quote-fill"%> me-1"></i>
			        	<%=commCategory.getName() %>
			        </a>
			    </li>
<%
	}
%>
			</ul>
			<!-- ì •ë ¬/í•„í„° ì‹œì‘ -->
			<div class="d-flex justify-content-end my-3">
				<select class="form-select" style="width:130px;" name="sort" onchange="changeSort()">
				<!-- 
					community.xml íŒŒì¼ì˜ getCommunitiesì—
					<isEqual property="sort" compareValue="~~"> ~~ </isEqual> ë¡œ ì¡°íšŒí•´ë‘ 
				 -->
					<option value="date" <%="date".equals(sort) ? "selected" : "" %>>ìµœì‹ ìˆœ</option>
					<option value="view" <%="view".equals(sort) ? "selected" : "" %>>ì¡°íšŒìˆœ</option>
					<option value="like" <%="like".equals(sort) ? "selected" : "" %>>ì¢‹ì•„ìš”ìˆœ</option>
				</select>
			</div>
			<!-- ê°™ì´í•´ìš” ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì‹œì‘ -->
			<div class="list-group p-3 mb-5">
<%
	if (communityList.isEmpty()) {
%>
				<h4 class="text-center m-5 p-5">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</h4>
<%
	} else {
		for (Community community : communityList) {
%>
		  	    <a href="detail.jsp?no=<%=community.getNo() %>&page=<%=currentPage %>" class="list-group-item list-group-item-action link-dark">
		  	        <div class="d-flex w-100 justify-content-between mb-3 pt-2">
		  	            <h6 class="mb-1 fw-bold" style="max-width: 936px;
		  	            							    height: 19.2px;
		  	            							    display: -webkit-box;
													    overflow: hidden;
													    text-overflow: ellipsis;
													    -webkit-box-orient: vertical;
													    -webkit-line-clamp: 1;">
		  	            	<%=community.getTitle() %>
		  	            </h6>
		  	            <small><%=DateUtils.toText(community.getCreatedDate()) %></small>
		  	        </div>
		  	        <div class="d-flex w-100 justify-content-start mb-3">
			  	        <img src="../resources/images/community/user_1077114.png" class="me-3" width="80" height="80" alt="...">
			  	        <p class="mb-1 text-secondary" style="height: 76px;
			        										  display: -webkit-box;
															  overflow: hidden;
															  text-overflow: ellipsis;
															  -webkit-box-orient: vertical;
															  -webkit-line-clamp: 3;">
							<%=community.getContent() %>
						</p>
		  	        </div>
		  	        <div class="d-flex w-100 justify-content-between mb-2">
		  	            <small class="fw-bold"><%=community.getUser().getName() %></small>
		  	            <small>ğŸ‘€ <%=community.getViewCnt() %>  |  ğŸ‘ <%=community.getLikeCnt() %></small>
		  	        </div>
		  	    </a>
<%
		}
	}
%>
			</div>
			<!-- ê²€ìƒ‰ ì‹œì‘ -->
			<form id="form-search" class="row row-cols-sm-auto justify-content-start align-items-center mb-5"
				  method="get"
				  action="list.jsp">
				<input type="hidden" name="catNo" value="<%=categoryNo != 0 ? categoryNo : "" %>" />
				<input type="hidden" name="page" value="<%=currentPage %>" />
				<input type="hidden" name="rows" value="<%=rows %>" />
				<input type="hidden" name="sort" value="<%=sort %>" />
				<div class="col-12">
					<select class="form-select" name="opt">
						<option value="">ì„ íƒ</option>
						<option value="title" <%="title".equals(opt) ? "selected" : "" %>>ì œëª©</option>
						<option value="writer" <%="writer".equals(opt) ? "selected" : "" %>>ì‘ì„±ì</option>
						<option value="content" <%="content".equals(opt) ? "selected" : "" %>>ë‚´ìš©</option>
					</select>
				</div>
				<div class="col-12">
					<input type="text" class="form-control" name="keyword" value="<%=keyword != null ? keyword : "" %>" />
				</div>
				<div class="col-12">
					<button onclick="searchCommunities()" type="submit" class="btn btn-outline-primary">ê²€ìƒ‰</button>
				</div>
			</form>
			<!-- í˜ì´ì§•ì²˜ë¦¬ ì‹œì‘ -->
<%
	// í˜ì´ì§€ ë‚´ë¹„ê²Œì´ì…˜ ìƒì„±
	int beginPage = pagination.getBeginPage();
	int endPage = pagination.getEndPage();
	
	boolean isFirst = pagination.isFirst();
	boolean isLast = pagination.isLast();
%>
<%
	if (pagination.getTotalRows() > 0) {
%>
			<div class="row">
				<div class="col-12">
					<nav aria-label="Page navigation example">
					  <ul class="pagination justify-content-center">
<%
		if (isFirst) {
%>
					    <li class="page-item disabled">
					      <a class="page-link"><</a>
					    </li>
<%
		} else {
%>
					    <li class="page-item">
					    	<a class="page-link"
					    	   href="list.jsp?page=<%=currentPage - 1%>"
					    	   onclick="goPage(<%=currentPage - 1 %>), event">
					    	<
					    	</a>
					    </li>
<%
		}
	
		for (int num = beginPage; num <= endPage; num++) {
%>
					    <li class="page-item <%=currentPage == num ? "active" : "" %>">
					      <a class="page-link"
					         href="list.jsp?page=<%=num %>"
					         onclick="goPage(<%=num %>, event)">
					         <%=num %>
					      </a>
					    </li>
<%
		}
	
		if (isLast) {
%>
					    <li class="page-item disabled">
					      <a class="page-link">></a>
					    </li>
<%
		} else {
%>
					    <li class="page-item">
					    	<a class="page-link"
					    	   href="list.jsp?page=<%=currentPage + 1%>"
					    	   onclick="gopage(<%=currentPage + 1 %>, event)">
					    	>
					    	</a>
					    </li>
<%
		}
%>
					  </ul>
					</nav>
				</div>
			</div>
<%
	}
%>
			<!-- í˜ì´ì§•ì²˜ë¦¬ ë -->
		</div>
	</div>
</div>
<script type="text/javascript">
	// ì¹´í…Œê³ ë¦¬ ì„ íƒí•´ë„ ì •ë ¬ë°©ì‹ ì´ˆê¸°í™”ë˜ì§€ ì•Šë„ë¡ í•´ì£¼ëŠ” í•¨ìˆ˜ (+ formì— catNoë„ hiddenìœ¼ë¡œ ì „ë‹¬í•´ì¤˜ì•¼ í•¨)
	function changeCategory(event, categoryNo) {
		event.preventDefault();
		
		// ê²€ìƒ‰í¼ì˜ íˆë“ í•„ë“œ(name=page)ë¥¼ 1ë¡œ ì„¤ì •
		document.querySelector("input[name=page]").value = 1;
		
		// íˆë“ í•„ë“œ(name=catNo)ì— ì¹´í…Œê³ ë¦¬ë²ˆí˜¸ê°€ ìˆì„ ë•Œë§Œ ì¹´í…Œê³ ë¦¬ë²ˆí˜¸ê°’ì„ ë„£ì–´ì£¼ê³ , ì¹´í…Œê³ ë¦¬ë²ˆí˜¸ê°€ ì—†ì„ ë•ŒëŠ” ë¹ˆê°’(ì „ì²´)ìœ¼ë¡œ ì„¤ì •
		if (categoryNo) {
			document.querySelector("input[name=catNo]").value = categoryNo;			
		} else  {
			document.querySelector("input[name=catNo]").value = "";
		}
		
		// ê²€ìƒ‰í¼ì˜ ì…ë ¥ê°’ì„ ì„œë²„ë¡œ ì œì¶œ
		document.getElementById("form-search").submit();
	}

	// ì •ë ¬ë°©ì‹ í•¨ìˆ˜
	function changeSort() {
		document.querySelector("input[name=page]").value = 1;
		let sort = document.querySelector("select[name=sort]").value;
		document.querySelector("input[name=sort]").value = sort;
		
		document.getElementById("form-search").submit();
	}
	
	// í˜ì´ì§€ ë²ˆí˜¸ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸í•¸ë“¤ëŸ¬ í•¨ìˆ˜ (ê²€ìƒ‰ì¡°ê±´, ê²€ìƒ‰ì–´ë„ í•¨ê»˜ ì „ë‹¬)
	function goPage(page, event) {
		event.preventDefault();
		
		document.querySelector("input[name=page]").value = page;
		document.getElementById("form-search").submit();
	}
	
	// ê²€ìƒ‰ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
	function searchCommunities() {
		document.querySelector("input[name=page]").value = 1;
		document.getElementById("form-search").submit();
	}
</script>
</body>
</html>